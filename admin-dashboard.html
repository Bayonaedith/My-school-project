<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ST Paul Learning Centre Admin Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<style>
  body { font-family: 'Roboto', sans-serif; margin:0; padding:0; background:#f5f5f5; }
  header { background:#1a73e8; color:white; padding:1rem; text-align:center; }
  main { padding:1rem; max-width:1000px; margin:auto; }
  .section { background:white; padding:1rem; margin-bottom:1rem; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
  input, select, button { padding:0.5rem; margin:0.5rem 0; width:100%; }
  table { width:100%; border-collapse: collapse; margin-top:1rem; }
  th, td { padding:0.5rem; border:1px solid #ddd; text-align:left; }
  th { background:#1a73e8; color:white; }
  .flex { display:flex; gap:1rem; flex-wrap:wrap; }
</style>
</head>
<body>

<header>
  <h1>ST Paul Learning Centre Admin Dashboard</h1>
  <p id="userRole"></p>
  <button onclick="logout()">Logout</button>
</header>

<main>

<!-- LOGIN FORM -->
<div id="loginSection" class="section">
  <h2>Login</h2>
  <input type="email" id="loginEmail" placeholder="Email">
  <input type="password" id="loginPassword" placeholder="Password">
  <button onclick="login()">Login</button>
  <button onclick="googleSignIn()">Login with Google</button>
</div>

<!-- ADMIN DASHBOARD -->
<div id="dashboard" style="display:none;">

  <!-- Add Student -->
  <div class="section">
    <h2>Add / Edit Student</h2>
    <input type="text" id="studentName" placeholder="Student Name">
    <input type="text" id="studentClass" placeholder="Class">
    <input type="text" id="studentParentPhone" placeholder="Parent Phone">
    <button onclick="addStudent()">Add Student</button>
  </div>

  <!-- Student List -->
  <div class="section">
    <h2>Student List</h2>
    <table id="studentTable">
      <thead>
        <tr>
          <th>Name</th>
          <th>Class</th>
          <th>Parent Phone</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Add Results -->
  <div class="section">
    <h2>Upload Results</h2>
    <select id="selectStudent"></select>
    <input type="text" id="subject" placeholder="Subject">
    <input type="number" id="score" placeholder="Score">
    <input type="text" id="term" placeholder="Term">
    <button onclick="addResult()">Add Result</button>
  </div>

</div>

<script type="module">
  // Firebase setup
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
  import { getFirestore, collection, doc, setDoc, getDocs, deleteDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCIu9Gi-TGqdjCsCxsyxyq1qV23pxVHOaI",
    authDomain: "my-school-project-6e00c.firebaseapp.com",
    projectId: "my-school-project-6e00c",
    storageBucket: "my-school-project-6e00c.appspot.com",
    messagingSenderId: "14283853516",
    appId: "1:14283853516:web:c7999ae32d83166cb8bc69"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUserRole = "";

  // LOGIN
  async function login() {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    try {
      const userCredential = await signInWithEmailAndPassword(auth, email, password);
      const uid = userCredential.user.uid;
      await loadDashboard(uid);
    } catch(e) { alert(e.message); }
  }

  async function googleSignIn() {
    const provider = new GoogleAuthProvider();
    try {
      const result = await signInWithPopup(auth, provider);
      const uid = result.user.uid;
      await loadDashboard(uid);
    } catch(e) { alert(e.message); }
  }

  function logout() {
    signOut(auth).then(() => location.reload());
  }

  // DASHBOARD LOAD
  async function loadDashboard(uid) {
    const userDoc = await getDocs(collection(db, 'users'));
    const userData = userDoc.docs.find(d => d.id === uid)?.data();
    currentUserRole = userData?.role || "student";
    document.getElementById('userRole').textContent = `Role: ${currentUserRole}`;

    document.getElementById('loginSection').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';

    loadStudents();
  }

  // STUDENT CRUD
  async function addStudent() {
    const name = document.getElementById('studentName').value;
    const studentClass = document.getElementById('studentClass').value;
    const parentPhone = document.getElementById('studentParentPhone').value;

    if(!name || !studentClass) return alert('Name & Class required');

    const newDoc = doc(collection(db, 'students'));
    await setDoc(newDoc, { name, class: studentClass, parentPhone, results:{} });
    document.getElementById('studentName').value='';
    document.getElementById('studentClass').value='';
    document.getElementById('studentParentPhone').value='';
  }

  function loadStudents() {
    const tbody = document.querySelector('#studentTable tbody');
    const select = document.getElementById('selectStudent');

    onSnapshot(collection(db, 'students'), (snapshot) => {
      tbody.innerHTML = '';
      select.innerHTML = '<option value="">Select Student</option>';

      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const id = docSnap.id;

        // Table
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${data.name}</td>
          <td>${data.class}</td>
          <td>${data.parentPhone}</td>
          <td>
            <button onclick="deleteStudent('${id}')">Delete</button>
          </td>`;
        tbody.appendChild(tr);

        // Select for results
        const option = document.createElement('option');
        option.value = id;
        option.textContent = data.name;
        select.appendChild(option);
      });
    });
  }

  async function deleteStudent(id) {
    if(confirm('Delete this student?')) {
      await deleteDoc(doc(db, 'students', id));
    }
  }

  // RESULTS
  async function addResult() {
    const studentId = document.getElementById('selectStudent').value;
    const subject = document.getElementById('subject').value;
    const score = Number(document.getElementById('score').value);
    const term = document.getElementById('term').value;

    if(!studentId || !subject || !score || !term) return alert('All fields required');

    const studentRef = doc(db, 'students', studentId);
    const studentDoc = await studentRef.get();
    const studentData = studentDoc.data();

    const newResults = studentData.results || {};
    if(!newResults[term]) newResults[term] = {};
    newResults[term][subject] = score;

    await updateDoc(studentRef, { results: newResults });

    document.getElementById('subject').value='';
    document.getElementById('score').value='';
    document.getElementById('term').value='';
    alert('Result added!');
  }
</script>

</body>
</html>
