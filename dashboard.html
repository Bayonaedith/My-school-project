<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard | St Paul Learning Centre</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  body { margin:0; font-family:'Poppins', sans-serif; background:#f4f6f9; }
  nav { background:#002147; color:white; padding:15px 40px; display:flex; justify-content:space-between; align-items:center; }
  nav h1 { margin:0; font-size:20px; }
  nav button { background:#ffcc00; border:none; padding:10px 20px; font-weight:600; cursor:pointer; border-radius:5px; }
  nav button:hover { background:#e6b800; }
  .container { padding:40px; }
  h2 { color:#002147; }
  table { width:100%; border-collapse: collapse; margin-top:20px; }
  th, td { border:1px solid #ccc; padding:12px; text-align:left; }
  th { background:#002147; color:white; }
  button.action-btn { padding:5px 10px; border:none; border-radius:5px; cursor:pointer; font-weight:600; }
  .approve { background:#28a745; color:white; }
  .reject { background:#dc3545; color:white; }
</style>
</head>
<body>

<nav>
  <h1>Admin Dashboard</h1>
  <button id="logoutBtn">Logout</button>
</nav>

<div class="container">
  <h2>Student Admissions</h2>
  <table id="admissionsTable">
    <thead>
      <tr>
        <th>Student Name</th>
        <th>Date of Birth</th>
        <th>Class</th>
        <th>Parent Name</th>
        <th>Parent Email</th>
        <th>Phone</th>
        <th>Message</th>
        <th>Submitted At</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Firebase + EmailJS SDKs -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { getFirestore, collection, getDocs, query, orderBy, doc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
import emailjs from "https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCIu9Gi-TGqdjCsCxsyxyq1qV23pxVHOaI",
  authDomain: "my-school-project-6e00c.firebaseapp.com",
  projectId: "my-school-project-6e00c",
  storageBucket: "my-school-project-6e00c.firebasestorage.app",
  messagingSenderId: "14283853516",
  appId: "1:14283853516:web:c7999ae32d83166cb8bc69",
  measurementId: "G-LTJZ2RDG15"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// EmailJS init
emailjs.init("S17h9x6ExMG6mKaQh");

const tableBody = document.querySelector("#admissionsTable tbody");
const logoutBtn = document.getElementById("logoutBtn");

// Check admin login
onAuthStateChanged(auth, (user) => {
  if (user && user.email === "nicholasbagenda@gmail.com") {
    loadAdmissions();
  } else {
    window.location.href = "login.html";
  }
});

// Logout
logoutBtn.addEventListener("click", () => {
  signOut(auth).then(() => window.location.href="login.html");
});

// Load Admissions
async function loadAdmissions() {
  tableBody.innerHTML = "";
  const admissionsRef = collection(db, "admissions");
  const q = query(admissionsRef, orderBy("submittedAt", "desc"));
  const snapshot = await getDocs(q);

  snapshot.forEach(async (docSnap) => {
    const data = docSnap.data();
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${data.studentName}</td>
      <td>${data.dob}</td>
      <td>${data.class}</td>
      <td>${data.parentName}</td>
      <td>${data.parentEmail}</td>
      <td>${data.parentPhone}</td>
      <td>${data.additionalInfo || ""}</td>
      <td>${data.submittedAt.toDate().toLocaleString()}</td>
      <td>${data.status || "Pending"}</td>
      <td>
        <button class="action-btn approve">Approve</button>
        <button class="action-btn reject">Reject</button>
      </td>
    `;

    // Approve
    row.querySelector(".approve").addEventListener("click", async () => {
      await setDoc(doc(db, "students", docSnap.id), {
        name: data.studentName,
        dob: data.dob,
        class: data.class,
        parentName: data.parentName,
        parentEmail: data.parentEmail,
        parentPhone: data.parentPhone,
        status: "active",
        createdAt: new Date()
      });
      await updateDoc(doc(db, "admissions", docSnap.id), { status: "Approved" });

      emailjs.send("service_ndh30l8","template_0k9iqza",{
        parent_email: data.parentEmail,
        student_name: data.studentName,
        login_email: data.parentEmail,
        login_password: "Default123!"
      }).then(()=> alert(`${data.studentName} approved & email sent!`));

      loadAdmissions();
    });

    // Reject
    row.querySelector(".reject").addEventListener("click", async () => {
      await updateDoc(doc(db, "admissions", docSnap.id), { status: "Rejected" });
      alert(`${data.studentName} has been rejected.`);
      loadAdmissions();
    });

    tableBody.appendChild(row);
  });
}
</script>

</body>
</html>
